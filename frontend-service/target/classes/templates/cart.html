<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>EcommercePro - Carrito</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>
    <link rel="stylesheet" th:href="@{/css/styles.css}"/>
</head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>
<div th:replace="~{fragments/alerts :: alerts}"></div>
<div th:replace="~{fragments/loader :: loader}"></div>
<div class="main-container container">
    <h2 class="mb-4">Carrito de Compras</h2>
    <div class="row">
        <div class="col-md-8">
            <table class="table table-hover">
                <thead>
                <tr>
                    <th>Producto</th>
                    <th>Categoría</th>
                    <th>Precio</th>
                    <th style="width:150px;">Cantidad</th>
                    <th>Total</th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
                <!-- Iterar productos del carrito -->
                <tr th:each="item : ${cartItems}" th:attr="data-pid=${item.productId}">
                    <td>
                        <div><strong th:text="${item.product != null ? item.product.name : 'Producto'}">Producto</strong></div>
                    </td>
                    <td th:text="${item.product != null && item.product.category != null && item.product.category != '' ? item.product.category : 'Sin categoría'}">Categoría</td>
                    <td th:text="${item.product != null && item.product.price != null ? 'S/ ' + #numbers.formatDecimal(item.product.price, 1, 'POINT', 2, 'COMMA') : 'S/ 0.00'}">S/ 0.00</td>
                    <td>
                        <div class="input-group input-group-sm">
                            <button class="btn btn-outline-secondary cart-dec-btn" type="button">−</button>
                            <input type="number" class="form-control text-center cart-qty-input" min="0" th:value="${item.quantity}" th:attr="max=${item.product != null ? item.product.stock : 0}" />
                            <button class="btn btn-outline-secondary cart-inc-btn" type="button" th:attr="disabled=${(item.product != null and item.product.stock != null) ? (item.quantity >= item.product.stock) : false}">+</button>
                        </div>
                    </td>
                    <td><span th:text="${item.total != null ? 'S/ ' + #numbers.formatDecimal(item.total, 1, 'POINT', 2, 'COMMA') : 'S/ 0.00'}">S/ 0.00</span></td>
                    <td><button class="btn btn-link cart-remove-btn" type="button">Eliminar</button></td>
                </tr>
                </tbody>
            </table>
                        <div class="d-flex justify-content-between">
                                <form method="post" action="/cart/clear" style="margin:0;">
                                        <!-- main button is type=button so JS can perform an AJAX clear; provide a <noscript> submit fallback -->
                                        <button id="cart-clear-btn" type="button" class="btn btn-outline-danger">Vaciar carrito</button>
                                        <noscript>
                                            <button type="submit" class="btn btn-outline-danger">Vaciar carrito</button>
                                        </noscript>
                                </form>
                <a href="/products" class="btn btn-light">Seguir comprando</a>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-3">
                <h4>Total a pagar</h4>
                <h2 id="cart-total-val" class="text-success" th:text="${cartTotal != null ? 'S/ ' + #numbers.formatDecimal(cartTotal, 1, 'POINT', 2, 'COMMA') : 'S/ 0.00'}">S/ 0.00</h2>
                <form th:action="@{/cart/checkout}" method="post">
                    <button type="submit" class="btn btn-primary w-100"
                            th:attr="disabled=${(cartItems == null or #lists.isEmpty(cartItems)) or (cartTotal == 0)}">
                        Pagar
                    </button>
                    <small class="text-muted d-block mt-2" th:if="${(cartItems == null or #lists.isEmpty(cartItems)) or (cartTotal == 0)}">El carrito está vacío, añade productos para pagar.</small>
                </form>
            </div>
        </div>
    </div>
</div>
<div th:replace="~{fragments/footer :: footer}"></div>

<!-- scripts -->
<div th:replace="~{fragments/scripts :: scripts}"></div>

<!-- Confirm remove modal (used when quantity becomes 0) -->
<div class="modal fade" id="confirmRemoveModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <p id="confirmRemoveMessage">¿Deseas eliminar este producto del carrito?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" id="confirmRemoveBtn" class="btn btn-danger">Eliminar</button>
            </div>
        </div>
    </div>
</div>

<!-- Expired payment notice modal -->
<div class="modal fade" id="expiredPaymentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                        <div class="modal-header">
                                <h5 class="modal-title">Tiempo de pago expirado</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                        </div>
                        <div class="modal-body">
                                <p>Tu sesión de pago expiró. Has sido redirigido al carrito. Pulsa Aceptar para continuar.</p>
                        </div>
                        <div class="modal-footer">
                                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Aceptar</button>
                        </div>
                </div>
        </div>
</div>

<script>
        (function(){
            try {
                const params = new URLSearchParams(window.location.search);
                function removeNoticeParam() {
                    try {
                        const url = new URL(window.location.href);
                        url.searchParams.delete('notice');
                        const clean = url.pathname + (url.search ? ('?' + url.searchParams.toString()) : '');
                        window.history.replaceState(null, '', clean);
                    } catch(e) { /* ignore */ }
                }
                if (params.get('notice') === 'expired_payment') {
                    // show bootstrap modal
                    var modalEl = document.getElementById('expiredPaymentModal');
                    if (modalEl && window.bootstrap && window.bootstrap.Modal) {
                        var m = new bootstrap.Modal(modalEl);
                        m.show();
                        // ensure URL is cleaned immediately so reload won't re-open the modal
                        removeNoticeParam();
                        // also remove when modal is closed (defensive)
                        modalEl.addEventListener('hidden.bs.modal', function(){ removeNoticeParam(); });
                    } else if (modalEl) {
                        // fallback: simple alert
                        alert('Tu sesión de pago expiró. Has sido redirigido al carrito.');
                        removeNoticeParam();
                    }
                }
            } catch(e) { /* ignore */ }
        })();
</script>
</body>
</html>
