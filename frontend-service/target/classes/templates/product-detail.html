<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Detalle de Producto - EcommercePro</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
</head>
<body class="bg-light">
    <div th:replace="~{fragments/navbar :: navbar}"></div>
    <div class="main-container container py-5">
        <div class="row justify-content-center">
            <div class="col-md-8" th:if="${product != null}">
                <div class="card shadow-sm">
                    <div class="row g-0">
                        <div class="col-md-5">
                       <img th:src="${product.imageUrl}" class="img-fluid rounded-start" alt="Imagen del producto"
                           onerror="this.onerror=null;this.src='/images/default-product.png'" />
                        </div>
                        <div class="col-md-7">
                            <div class="card-body">
                                <h3 class="card-title fw-bold" th:text="${product.name}"></h3>
                                <p class="card-text text-muted" th:text="${product.description}"></p>
                                <h4 class="text-primary fw-bold mb-3" th:text="${product.price != null ? 'S/ ' + #numbers.formatDecimal(product.price, 1, 'POINT', 2, 'COMMA') : 'S/ 0.00'}"></h4>
                                <form th:action="@{/cart/add}" method="post" class="add-to-cart-ajax">
                                    <input type="hidden" name="productId" th:value="${product.id}" />
                                    <div class="mb-3">
                                        <label for="quantity" class="form-label">Cantidad</label>
                                        <input type="number" id="quantity" name="quantity" class="form-control" min="1" max="99" value="1" required />
                                        <div class="invalid-feedback">La cantidad debe ser entre 1 y 99.</div>
                                    </div>
                                    <button type="button" id="addToCartBtn" class="btn btn-success">Agregar al carrito</button>
                                </form>
                                <div th:replace="~{fragments/alerts :: alerts}"></div>
                                <script>
                                    (function(){
                                        var btn = document.getElementById('addToCartBtn');
                                        if(!btn) return;
                                        btn.addEventListener('click', function(e){
                                            try{
                                                var form = btn.closest('form');
                                                var url = form.getAttribute('action') || '/cart/add';
                                                var fd = new FormData(form);
                                                fetch(url, { method: 'POST', body: fd, credentials: 'same-origin', headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                                                  .then(function(resp){ if(resp.ok) return resp.text(); throw new Error('Error'); })
                                                  .then(function(){
                                                      // simple toast
                                                      var container = document.getElementById('ecom-toast-container');
                                                      if(container){
                                                          var id = 't' + Date.now();
                                                          var html = '<div id="'+id+'" class="toast align-items-center text-bg-success border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">'
                                                              + '<div class="d-flex"><div class="toast-body">Producto agregado al carrito</div>'
                                                              + '<button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div></div>';
                                                          container.insertAdjacentHTML('beforeend', html);
                                                          var el = document.getElementById(id);
                                                          var bs = bootstrap.Toast.getOrCreateInstance(el, { delay: 2500 }); bs.show();
                                                          el.addEventListener('hidden.bs.toast', function(){ el.remove(); });
                                                      }
                                                      // refresh badge
                                                      fetch('/api/cart/refresh-badge', { credentials: 'same-origin' }).then(function(r){ if(!r.ok) return; return r.json(); }).then(function(j){ if(!j) return; var c=j.count||0; var el=document.getElementById('cart-badge'); if(!el) return; if(c<=0) el.remove(); else { var display = c<100?String(c):'99+'; el.textContent = display; el.setAttribute('title', c + ' items'); el.classList.remove('badge-pop'); void el.offsetWidth; el.classList.add('badge-pop'); try{ var t = bootstrap.Tooltip.getOrCreateInstance(el); t.dispose(); bootstrap.Tooltip.getOrCreateInstance(el); }catch(ex){} } });
                                                  })
                                                  .catch(function(){
                                                    var container = document.getElementById('ecom-toast-container');
                                                    if(container){
                                                      var id='err'+Date.now();
                                                      var html = '<div id="'+id+'" class="toast align-items-center text-bg-danger border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">'
                                                              + '<div class="d-flex"><div class="toast-body">No se pudo agregar al carrito</div>'
                                                              + '<button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div></div>';
                                                      container.insertAdjacentHTML('beforeend', html);
                                                      var el = document.getElementById(id);
                                                      var bs = bootstrap.Toast.getOrCreateInstance(el, { delay: 2500 }); bs.show();
                                                      el.addEventListener('hidden.bs.toast', function(){ el.remove(); });
                                                    }
                                                  });
                                            }catch(e){ }
                                        });
                                    })();
                                </script>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div th:replace="~{fragments/footer :: footer}"></div>
</body>
</html>
